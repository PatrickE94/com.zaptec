<html>
  <head>
    <link href="./style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>

  <body class="homey-widget-full">
    <div class="main-container">
      <div class="left-section">
        <!-- Charging indicator overlay -->
        <div class="charging-indicator" id="chargingIndicator" style="display: none;">
          <i class="material-icons">bolt</i>
        </div>
      </div>
      <div class="right-section">
        <div class="locks-container" id="locksContainer">
          <button class="icon-button filled-icon-button">
            <i class="material-icons">lock</i>
          </button>
          <p class="homey-text-small" data-i18n="widget.cable">Cable</p>
          <p class="homey-text-small-light">loading...</p>
        </div>
        <div class="locks-container fab-container" id="chargeModeContainer">
          <!-- Main round button -->
          <button class="icon-button filled-icon-button fab-main" id="mainChargeFab">
            <i class="material-icons">bolt</i>
          </button>
          
          <!-- Mini FABs for options (initially hidden) - horizontal layout -->
          <div class="fab-menu-horizontal" id="fabMenuHorizontal" style="display: none;">
            <button class="fab mini-fab" id="standardFab" data-mode="0">
              <i class="material-icons">flash_on</i>
            </button>
            <button class="fab mini-fab" id="smartFab" data-mode="4">
              <i class="material-icons">psychology</i>
            </button>
            <button class="fab mini-fab" id="scheduleFab" data-mode="16">
              <i class="material-icons">schedule</i>
            </button>
          </div>
          
          <p class="homey-text-small" data-i18n="widget.chargemode">Chargemode</p>
          <p class="homey-text-small-light">loading...</p>
        </div>
        <div class="locks-container" id="accessContainer">
          <button class="icon-button filled-icon-button">
            <i class="material-icons">key</i>
          </button>
          <p class="homey-text-small" data-i18n="widget.access">Access</p>
          <p class="homey-text-small-light">loading...</p>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      function onHomeyReady(Homey) {
        Homey.ready({ height: 150 });

        const $locksContainer = document.getElementById('locksContainer');
        const $accessContainer = document.getElementById('accessContainer');
        const $chargeModeContainer = document.getElementById('chargeModeContainer');
        const $cableIcon = $locksContainer.querySelector('.material-icons');
        const $cableStatusText = $locksContainer.querySelector('.homey-text-small-light');
        const $accessIcon = $accessContainer.querySelector('.material-icons');
        const $accessStatusText = $accessContainer.querySelector('.homey-text-small-light');
        const $chargeModeStatusText = $chargeModeContainer.querySelector('.homey-text-small-light');
        const $mainContainer = document.querySelector('.main-container');
        const $homeyTextSmallElements = document.querySelectorAll('.homey-text-small');

        const $selectedDeviceId = Homey.getDeviceIds()[0];
        const $cableButton = $locksContainer.querySelector('.icon-button');
        const $accessButton = $accessContainer.querySelector('.icon-button');
        const $mainChargeFab = document.getElementById('mainChargeFab');
        const $fabMenuHorizontal = document.getElementById('fabMenuHorizontal');
        const $miniFabs = document.querySelectorAll('.mini-fab');
        const $chargingIndicator = document.getElementById('chargingIndicator');

        // Add click event listener to cable button
        $cableButton.addEventListener('click', (e) => {
          // console.log('Cable button clicked'); // Debug log
          e.preventDefault();
          e.stopPropagation();
          
          const isCurrentlyLocked = $locksContainer.classList.contains('locked');
          const newLockState = !isCurrentlyLocked; 
          
          // console.log('Current lock state:', isCurrentlyLocked, 'New state:', newLockState); // Debug log
          
          // Show loading state
          $cableStatusText.textContent = 'Updating...';
          $cableButton.style.opacity = '0.6';
          
          Homey.api('POST', `/?deviceId=${$selectedDeviceId}`, {
            lock: newLockState
          })
          .then(() => {
            // console.log('Lock command sent successfully');
            // Reset button appearance
            $cableButton.style.opacity = '1';
            // Force update immediately after successful API call
            setTimeout(updateChargeMode, 100);
          })
          .catch(error => {
            console.error('Error locking/unlocking charger:', error);
            // Reset button appearance on error
            $cableButton.style.opacity = '1';
            $cableStatusText.textContent = 'Error';
          });
        });

        // Add click event listener to access button
        $accessButton.addEventListener('click', (e) => {
          // console.log('Access button clicked'); // Debug log
          e.preventDefault();
          e.stopPropagation();
          
          const isCurrentlyRestricted = $accessContainer.classList.contains('locked');
          const newAuthState = !isCurrentlyRestricted; 
          
          // console.log('Current auth state:', isCurrentlyRestricted, 'New state:', newAuthState); // Debug log
          
          // Show loading state
          $accessStatusText.textContent = 'Updating...';
          $accessButton.style.opacity = '0.6';
          
          Homey.api('PUT', `/auth?deviceId=${$selectedDeviceId}`, {
            requireAuthentication: newAuthState
          })
          .then(() => {
            // console.log('Authentication requirement updated successfully');
            // Reset button appearance
            $accessButton.style.opacity = '1';
            // Force update immediately after successful API call
            setTimeout(updateChargeMode, 100);
          })
          .catch(error => {
            console.error('Error setting authentication requirement:', error);
            // Reset button appearance on error
            $accessButton.style.opacity = '1';
            $accessStatusText.textContent = 'Error';
          });
        });

        // Add click event listener to main FAB
        let fabMenuOpen = false;
        $mainChargeFab.addEventListener('click', (e) => {
          e.stopPropagation();
          fabMenuOpen = !fabMenuOpen;
          
          if (fabMenuOpen) {
            $fabMenuHorizontal.style.display = 'flex';
            $fabMenuHorizontal.classList.add('show');
          } else {
            $fabMenuHorizontal.classList.remove('show');
            setTimeout(() => {
              $fabMenuHorizontal.style.display = 'none';
            }, 200);
          }
        });

        // Handle mini FAB clicks
        $miniFabs.forEach(fab => {
          fab.addEventListener('click', (e) => {
            e.stopPropagation();
            const selectedMode = fab.getAttribute('data-mode');
            
            Homey.api('PUT', `/charging-mode?deviceId=${$selectedDeviceId}`, {
              chargingMode: selectedMode
            })
            .then(() => {
              // console.log('Charging mode updated successfully');
              // Hide FABs after selection
              fabMenuOpen = false;
              $fabMenuHorizontal.classList.remove('show');
              setTimeout(() => {
                $fabMenuHorizontal.style.display = 'none';
              }, 200);
            })
            .catch(error => {
              console.error('Error setting charging mode:', error);
            });
          });
        });

        // Hide FAB menu when clicking outside
        document.addEventListener('click', () => {
          if (fabMenuOpen) {
            fabMenuOpen = false;
            $fabMenuHorizontal.classList.remove('show');
            setTimeout(() => {
              $fabMenuHorizontal.style.display = 'none';
            }, 200);
          }
        });

        // Mapping for charging mode verdier
        function getChargingModeText(value) {
          switch(value) {
            case '0':
            case 0:
              return Homey.__("widget.chargingmode.standard");
            case '4':
            case 4:
              return Homey.__("widget.chargingmode.smart");
            case '16':
            case 16:
              return Homey.__("widget.chargingmode.schedule");
            default:
              return Homey.__("widget.chargingmode.standard");
          }
        }
       
        function updateChargeMode() {
          Homey.api('GET', `/?deviceId=${$selectedDeviceId}`)
            .then(data => {

              //test
              // data.driverType = 'pro';
              // data.cablePermanentLock = false;
              // data.chargingMode = 1;
              // data.requireAuthentication = false;
              // data.chargingButton = true
              //test

              // console.log(data);
      
              if (data.driverType === 'pro' || data.driverType === 'home') {
                $mainContainer.classList.add('pro-background');
                $mainContainer.classList.remove('go-background');
              } else if (data.driverType === 'go' || data.driverType === 'go2') {
                $mainContainer.classList.add('go-background');
                $mainContainer.classList.remove('pro-background');
              } else {
                $mainContainer.classList.remove('pro-background', 'go-background');
              }

              // Legg til/fjern .go klasse på alle homey-text-small elementer
              $homeyTextSmallElements.forEach(element => {
                if (data.driverType === 'go' || data.driverType === 'go2') {
                  element.classList.add('go');
                } else {
                  element.classList.remove('go');
                }
              });
              
              // Oppdater cable lock basert på capability
              if (data.cablePermanentLock === true) {
                // Locked state
                $locksContainer.classList.remove('unlocked');
                $locksContainer.classList.add('locked');
                $cableIcon.textContent = 'lock';
                $cableStatusText.textContent = Homey.__("widget.locked");
                // console.log('Cable updated to locked state');
              } else {
                // Unlocked state
                $locksContainer.classList.remove('locked');
                $locksContainer.classList.add('unlocked');
                $cableIcon.textContent = 'lock_open';
                $cableStatusText.textContent = Homey.__("widget.unlocked");
                // console.log('Cable updated to unlocked state');
              }

              // Oppdater access basert på requireAuthentication setting
              if (data.requireAuthentication === true) {
                // Begrenset tilgang - grønn bakgrunn
                $accessContainer.classList.remove('unlocked');
                $accessContainer.classList.add('locked');
                $accessStatusText.textContent = Homey.__("widget.restricted");
                // console.log('Access updated to restricted state');
              } else {
                // Åpen tilgang - grå bakgrunn
                $accessContainer.classList.remove('locked');
                $accessContainer.classList.add('unlocked');
                $accessStatusText.textContent = Homey.__("widget.open");
                // console.log('Access updated to open state');
              }

              // Oppdater charge mode basert på charging_mode capability
              $chargeModeStatusText.textContent = getChargingModeText(data.chargingMode);

              // Oppdater charging indicator basert på charging_button capability
              if (data.chargingButton === true) {
                $chargingIndicator.style.display = 'flex';
              } else {
                $chargingIndicator.style.display = 'none';
              }
              
            })
            .catch(error => {
              console.error('Error fetching data:', error);
            });
        }

        // Oppdater umiddelbart
        updateChargeMode();

        setInterval(updateChargeMode, 2000);

      }
       
    </script>
  </body>
</html>